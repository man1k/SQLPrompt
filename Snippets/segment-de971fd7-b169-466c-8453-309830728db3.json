{
  "id": "de971fd7-b169-466c-8453-309830728db3",
  "prefix": "segment",
  "description": "Segment adhoc query",
  "body": "USE TradeNetworks;\nGO\n\nSET NOCOUNT ON;\n\nDROP TABLE IF EXISTS #LeadSegments;\n\nRAISERROR ('Prepare the list to be intserted!', 0, 1) WITH NOWAIT;\n\nSELECT\n     ls.LeadId       AS LeadId\n   , 8               AS DimensionId\n   , ls.SegmentValue AS SegmentValue\n   , NULL            AS RuleId\n   , GETDATE ()      AS LastUpdatedDateTime\n   , 1               AS LastUpdatedByUserId\nINTO #LeadSegments\nFROM (\n         VALUES (\n                    7434888, 2\n                )\n              , (\n                    8101619, 2\n                )\n     ) AS ls (LeadId, SegmentValue);\n\nRAISERROR ('     - (%10u rows affected)', 0, 1, @@ROWCOUNT) WITH NOWAIT;\n\nRAISERROR ('Delete Existing data!', 0, 1) WITH NOWAIT;\n\nDELETE FROM CRM.LeadSegments\nWHERE DimensionId = 8;\n\nRAISERROR ('     - (%10u rows affected)', 0, 1, @@ROWCOUNT) WITH NOWAIT;\n\nRAISERROR ('Insert new for existing leads!', 0, 1) WITH NOWAIT;\n\nINSERT INTO CRM.LeadSegments (\n                                 LeadId\n                               , DimensionId\n                               , SegmentValue\n                               , RuleId\n                               , LastUpdatedDateTime\n                               , LastUpdatedByUserId\n                             )\n            SELECT\n                 tls.LeadId\n               , tls.DimensionId\n               , tls.SegmentValue\n               , tls.RuleId\n               , tls.LastUpdatedDateTime\n               , tls.LastUpdatedByUserId\n            FROM #LeadSegments AS tls\n            WHERE\n                 EXISTS (\n                            SELECT 1\n                            FROM   CRM.Leads AS l\n                            WHERE  tls.LeadId = l.LeadId\n                        );\n\nRAISERROR ('     - (%10u rows affected)', 0, 1, @@ROWCOUNT) WITH NOWAIT;\n\nRAISERROR ('Show list of missing leads!', 0, 1) WITH NOWAIT;\n\nSELECT\n      tls.LeadId\n    , tls.DimensionId\n    , tls.SegmentValue\n    , tls.RuleId\n    , tls.LastUpdatedDateTime\n    , tls.LastUpdatedByUserId\nFROM  #LeadSegments AS tls\nWHERE NOT EXISTS (\n                     SELECT 1\n                     FROM   CRM.Leads AS l\n                     WHERE  tls.LeadId = l.LeadId\n                 );\n\n"
}