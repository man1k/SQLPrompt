{
  "id": "2918fa84-ad9a-43f5-ad89-3f58778fed56",
  "prefix": "CopyTable",
  "description": "Copy table",
  "body": "DECLARE @DestinationSchema NVARCHAR (50) = 'PushNotifications';\nDECLARE @SourceSchema NVARCHAR (50) = 'CRM';\n\nSELECT\n            so.name                                                                       AS TableName\n          , N'create table [' + @DestinationSchema + '].[' + so.name + '] (' + o.list + (CASE WHEN kc.name IS NULL\n                                                                                              THEN ''\n                                                                                              ELSE ' CONSTRAINT ' + kc.name + ' PRIMARY KEY CLUSTERED ' + ' (' + LEFT(j.list, LEN (j.list) - 1) + '))'\n                                                                                         END\n                                                                                        ) AS TableScript\nFROM\n            sys.objects AS so\nCROSS APPLY (\n                SELECT\n                    -- column name\n                          '  [' + cl.name + '] ' +\n                    -- column type\n                    t.name +\n                    -- type lenght\n                    (CASE t.name\n                          WHEN 'sql_variant'\n                          THEN ''\n                          WHEN 'text'\n                          THEN ''\n                          WHEN 'ntext'\n                          THEN ''\n                          WHEN 'bit'\n                          THEN ''\n                          WHEN 'int'\n                          THEN ''\n                          WHEN 'tinyint'\n                          THEN ''\n                          WHEN 'smallint'\n                          THEN ''\n                          WHEN 'bigint'\n                          THEN ''\n                          WHEN 'timestamp'\n                          THEN ''\n                          WHEN 'date'\n                          THEN ''\n                          WHEN 'smalldatetime'\n                          THEN ''\n                          WHEN 'datetime'\n                          THEN ''\n                          WHEN 'datetime2'\n                          THEN ''\n                          WHEN 'real'\n                          THEN ''\n                          WHEN 'float'\n                          THEN ''\n                          WHEN 'time'\n                          THEN ''\n                          WHEN 'decimal'\n                          THEN '(' + CAST(cl.precision AS VARCHAR) + ', ' + CAST(cl.scale AS VARCHAR) + ')'\n                          ELSE '(' + (CASE WHEN cl.max_length = -1 THEN 'MAX' ELSE CAST(cl.max_length AS VARCHAR)END) + ')'\n                     END\n                    )     + ' ' +\n                    -- nullable\n                    (CASE WHEN cl.is_nullable = 0 THEN 'NOT ' ELSE '' END) + 'NULL,'\n                FROM\n                          sys.columns AS cl\n               INNER JOIN sys.types   AS t\n                       ON cl.user_type_id = t.user_type_id\n                WHERE     cl.object_id = so.object_id\n                ORDER BY  cl.column_id\n                FOR XML PATH ('')\n            )           AS o(list)\nINNER JOIN  sys.schemas         AS sch\n        ON  so.schema_id = sch.schema_id\n        AND sch.name = @SourceSchema\nLEFT JOIN   sys.key_constraints AS kc\n       ON   so.object_id = kc.parent_object_id\n        AND kc.type = 'PK'\n        AND kc.schema_id = so.schema_id\nCROSS APPLY (\n                SELECT    N'[' + col.name + '], '\n                FROM\n                          sys.columns       AS col\n               INNER JOIN sys.indexes       AS i\n                       ON col.object_id    = i.object_id\n                      AND i.is_primary_key = 1\n               INNER JOIN sys.index_columns AS ic\n                       ON ic.object_id     = so.object_id\n                      AND ic.column_id     = col.column_id\n                      AND ic.index_id      = i.index_id\n                WHERE     col.object_id = so.object_id\n                ORDER BY  ic.key_ordinal\n                FOR XML PATH ('')\n            )                   AS j(list)\nCROSS APPLY (\n                SELECT    N'[Destination].[' + col.name + '] = [Source].[' + col.name + '] AND '\n                FROM\n                          sys.columns       AS col\n               INNER JOIN sys.indexes       AS i\n                       ON col.object_id    = i.object_id\n                      AND i.is_primary_key = 1\n               INNER JOIN sys.index_columns AS ic\n                       ON ic.object_id     = so.object_id\n                      AND ic.column_id     = col.column_id\n                      AND ic.index_id      = i.index_id\n                WHERE     col.object_id = so.object_id\n                ORDER BY  ic.key_ordinal\n                FOR XML PATH ('')\n            ) AS k(list)\nWHERE       so.type = 'U'\nORDER BY    so.name;"
}