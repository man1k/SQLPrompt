{
  "id": "72b45c6a-64ca-4000-9745-ecf336216743",
  "prefix": "crdbclone",
  "description": "Create database Clone",
  "body": "USE model;\r\nGO\r\nDROP TRIGGER IF EXISTS TR_sys_TableCompressionsVerification\r\nON DATABASE;\r\nGO\r\nDROP USER IF EXISTS [CLOUDAD\\scRedGateMonitor];\r\nGO\r\n\r\nUSE master;\r\nGO\r\n\r\nDECLARE @SQL NVARCHAR (MAX) = N'';\r\n\r\nSELECT @SQL += N'ALTER DATABASE[' + d.name + N'] SET SINGLE_USER WITH ROLLBACK IMMEDIATE; DROP DATABASE [' + d.name + N'];'\r\nFROM   sys.databases AS d\r\nWHERE\r\n       d.name LIKE '$DatabaseName$[_]%'\r\n   AND d.create_date < CAST(GETDATE () AS DATE);\r\n\r\nEXEC sys.sp_executesql @SQL;\r\n\r\nDECLARE\r\n    @DatabaseName   VARCHAR (256)\r\n  , @NewCloneDBName VARCHAR (256)\r\n  , @OldCloneDBName VARCHAR (256);\r\n\r\nSELECT @DatabaseName = '$DatabaseName$';\r\nSELECT @NewCloneDBName = @DatabaseName + '_' + REPLACE (CONVERT (VARCHAR (15), GETDATE (), 106), ' ', '');\r\n\r\nDBCC CLONEDATABASE(@DatabaseName, @NewCloneDBName);\r\nGO\r\n\r\nEXEC Configuration.Security.FixPermisions\r\n    @ApplicationServerLogins = 0\r\n  , @UseDefaultDomainColum = 0\r\n  , @ForUser = N'CLOUDAD\\scRedGateMonitor'\r\n  , @ForDataBase = N'model';\r\n\r\n\r\nDECLARE\r\n    @DBName       NVARCHAR (256)\r\n  , @SQL          NVARCHAR (MAX)\r\n  , @DatafileName NVARCHAR (256)\r\n  , @LogfileName  NVARCHAR (256);\r\n\r\n\r\nSELECT      TOP 1\r\n            @DBName       = d.name\r\n          , @DatafileName = f.DatafileName\r\n          , @LogfileName  = f.LogfileName\r\nFROM\r\n            sys.databases AS d\r\nCROSS APPLY (\r\n                SELECT\r\n                     piv.DatafileName\r\n                   , piv.LogfileName\r\n                FROM (\r\n                         SELECT\r\n                               CASE WHEN mf.type = 0 THEN 'DatafileName' ELSE 'LogfileName' END AS FileType\r\n                             , mf.name                                                          AS FileName\r\n                         FROM  sys.master_files AS mf\r\n                         WHERE d.database_id = mf.database_id\r\n                     ) AS mf\r\n                PIVOT (\r\n                          MAX(FileName)\r\n                          FOR FileType IN (\r\n                                              DatafileName, LogfileName\r\n                                          )\r\n                      ) AS piv\r\n            )             AS f\r\nORDER BY    d.create_date DESC;\r\n\r\nSELECT @SQL = N'\r\nUSE master;\r\nALTER DATABASE ' + QUOTENAME (@DBName) + N' SET READ_WRITE;\r\nALTER DATABASE ' + QUOTENAME (@DBName) + N' SET QUERY_STORE CLEAR;';\r\n\r\nEXEC sys.sp_executesql @SQL;\r\n\r\nSELECT @SQL = N'\r\nUSE ' + QUOTENAME (@DBName) + N';\r\nDBCC SHRINKFILE(' + QUOTENAME (@DatafileName, '''') + N', 32);\r\nCHECKPOINT;\r\nDBCC SHRINKFILE(' + QUOTENAME (@LogfileName, '''') + N', 32);';\r\n\r\nEXEC sys.sp_executesql @SQL;\r\n\r\nSELECT @SQL = N'\r\nUSE master;\r\nALTER DATABASE ' + QUOTENAME (@DBName) + N' SET READ_ONLY;';\r\n\r\nEXEC sys.sp_executesql @SQL;\r\n",
  "placeholders": [
    {
      "name": "DatabaseName",
      "defaultValue": "$DBNAME$"
    }
  ]
}