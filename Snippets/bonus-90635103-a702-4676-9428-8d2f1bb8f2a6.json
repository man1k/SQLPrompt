{
  "id": "90635103-a702-4676-9428-8d2f1bb8f2a6",
  "prefix": "bonus",
  "description": "",
  "body": "USE LEADMANAGEMENT_4_BFOREX;\nGO\n\nBEGIN TRANSACTION;\n\nDECLARE @CopyFromOU INT;\nDECLARE @CopyToOU TABLE (\n    UnitId INT\n);\n\n/*~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~*\\ \n\tGet organization units unit id's (from and to)\n\\*~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~*/\nSELECT @CopyFromOU = ou.unit_id\nFROM   dbo.organization_units AS ou\nWHERE\n    --ou.name = 'Swedish Team';\n       ou.unit_id = 433 --PY PT Team A\n\nINSERT INTO @CopyToOU (\n                          UnitId\n                      )\n            SELECT ou.unit_id\n            FROM   dbo.organization_units AS ou\n            WHERE\n                --ou.name IN (\n                --               'Malaga M', 'Swedish Team', 'MM SWE'\n                --           );\n                   ou.unit_id IN (\n                                    477 --PY PT Team C\n                                 );\n\n/*~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~*\\ \n\tPrepare a temp table with data to insert\n\\*~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~*/\nIF OBJECT_ID ('tempdb..#organization_units_bonus_stategy_new_assoc') IS NOT NULL\n    DROP TABLE #organization_units_bonus_stategy_new_assoc;\n\nSELECT\n           cto.UnitId                  AS unit_id\n         , oubsna.bonus_strategy_id    AS bonus_strategy_id\n         , oubsna.effective_date_start AS effective_date_start\n         , oubsna.effective_date_end   AS effective_date_end\n         , oubsna.created_by           AS created_by\n         , oubsna.created_date         AS created_date\n         , oubsna.changed_by           AS changed_by\n         , oubsna.changed_date         AS changed_date\nINTO       #organization_units_bonus_stategy_new_assoc\nFROM\n           dbo.organization_units_bonus_stategy_new_assoc AS oubsna\nCROSS JOIN @CopyToOU                                      AS cto\nWHERE\n           oubsna.unit_id = @CopyFromOU\n       AND oubsna.effective_date_end IS NULL;\n\n/*~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~*\\ \n\tSELECT Before Insert state\n\\*~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~*/\nSELECT     *\nFROM\n           dbo.organization_units_bonus_stategy_new_assoc AS oubsna\nINNER JOIN @CopyToOU                                      AS cto\n        ON oubsna.unit_id = cto.UnitId;\n\n/*~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~*\\ \n\tINSERT missing data\n\\*~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~*/\nINSERT INTO dbo.organization_units_bonus_stategy_new_assoc (\n                                                               unit_id\n                                                             , bonus_strategy_id\n                                                             , effective_date_start\n                                                             , effective_date_end\n                                                             , created_by\n                                                             , created_date\n                                                             , changed_by\n                                                             , changed_date\n                                                           )\n            SELECT\n                  toubsna.unit_id\n                , toubsna.bonus_strategy_id\n                , toubsna.effective_date_start\n                , toubsna.effective_date_end\n                , toubsna.created_by\n                , toubsna.created_date\n                , toubsna.changed_by\n                , toubsna.changed_date\n            FROM  #organization_units_bonus_stategy_new_assoc AS toubsna\n            WHERE NOT EXISTS (\n                                 SELECT *\n                                 FROM   dbo.organization_units_bonus_stategy_new_assoc AS oubsna\n                                 WHERE\n                                        oubsna.unit_id              = toubsna.unit_id\n                                    AND oubsna.bonus_strategy_id    = toubsna.bonus_strategy_id\n                                    AND oubsna.effective_date_start = toubsna.effective_date_start\n                             );\n\n/*~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~*\\ \n\tSELECT After Insert state\n\\*~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~*/\nSELECT     *\nFROM\n           dbo.organization_units_bonus_stategy_new_assoc AS oubsna\nINNER JOIN @CopyToOU                                      AS cto\n        ON oubsna.unit_id = cto.UnitId;\n\nROLLBACK TRANSACTION;\n--COMMIT TRANSACTION;\n"
}